# Diagrama de Flujo: Arquitectura Multi-Agente

## Vista General del Flujo

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          INICIO DE TURNO                                 â”‚
â”‚                     (Usuario envÃ­a mensaje)                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                                   â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   input_processor        â”‚
                    â”‚  (Normaliza input)       â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   policy_engine          â”‚
                    â”‚  (EvalÃºa polÃ­ticas)      â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   eligibility_checker    â”‚
                    â”‚  (Verifica elegibilidad) â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   escalation_detector    â”‚
                    â”‚  (Detecta escalaciÃ³n)    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  Â¿Requiere escalaciÃ³n?   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚                         â”‚
                 SÃ                        NO
                  â”‚                         â”‚
                  â–¼                         â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ special_case_handler  â”‚   â”‚ ğŸ¤– AGENTE A                     â”‚
    â”‚  (Manejo especial)    â”‚   â”‚ context_emotion_analyzer       â”‚
    â”‚                       â”‚   â”‚ (Analiza sentimiento y contexto)â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚                           â”‚
               â”‚                           â”‚ Actualiza state:
               â”‚                           â”‚ - current_sentiment
               â”‚                           â”‚ - conflict_level
               â”‚                           â”‚ - personality_mode
               â”‚                           â”‚ - emotional_memory
               â”‚                           â”‚
               â–¼                           â–¼
            [END]              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                               â”‚   context_builder         â”‚
                               â”‚ (Construye prompt base)   â”‚
                               â”‚ - PolÃ­ticas relevantes    â”‚
                               â”‚ - Casos similares         â”‚
                               â”‚ - Datos conocidos         â”‚
                               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                          â”‚
                                          â–¼
                               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                               â”‚ ğŸ­ AGENTE B                â”‚
                               â”‚ orchestrator              â”‚
                               â”‚ (Genera respuesta)        â”‚
                               â”‚                           â”‚
                               â”‚ Adaptaciones:             â”‚
                               â”‚ - Tono emocional          â”‚
                               â”‚ - Modo personalidad       â”‚
                               â”‚ - ValidaciÃ³n emocional    â”‚
                               â”‚ - CorrecciÃ³n Guardrail    â”‚
                               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                          â”‚
                                          â”‚ Genera:
                                          â”‚ - agent_response
                                          â”‚ - next_phase
                                          â”‚ - extracted_data
                                          â”‚
                                          â–¼
                               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                               â”‚ ğŸ›¡ï¸ AGENTE C                â”‚
                               â”‚ safety_validator          â”‚
                               â”‚ (Valida respuesta)        â”‚
                               â”‚                           â”‚
                               â”‚ Validaciones:             â”‚
                               â”‚ 1. Fallo lÃ³gico           â”‚
                               â”‚ 2. Seguridad              â”‚
                               â”‚ 3. Accesibilidad          â”‚
                               â”‚ 4. Consistencia           â”‚
                               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                          â”‚
                                          â”‚ validation_attempt_count++
                                          â”‚
                                          â–¼
                               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                               â”‚ Â¿ValidaciÃ³n aprobada?     â”‚
                               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                          â”‚
                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                       â”‚                                     â”‚
                    REJECTED                             APPROVED
                       â”‚                                     â”‚
                       â–¼                                     â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ Â¿Intentos < 3?       â”‚           â”‚   response_processor   â”‚
            â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚ (Extrae datos y        â”‚
                   â”‚                           â”‚  actualiza state)      â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                     â”‚                           â”‚
       SÃ                    NO                           â–¼
        â”‚                     â”‚                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                     â”‚                â”‚ Routing despuÃ©s LLM  â”‚
        â”‚ (Volver a regenerar)â”‚                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                     â”‚                           â”‚
        â–¼                     â–¼                           â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ orchestratorâ”‚   â”‚ APPROVED    â”‚         â”‚         â”‚          â”‚
    â”‚ (con        â”‚   â”‚ (auto)      â”‚        END    SPECIAL      CONTINUE
    â”‚ correction) â”‚   â”‚             â”‚         â”‚         â”‚          â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜         â–¼         â–¼          â–¼
          â”‚                  â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚                  â”‚          â”‚  excel_  â”‚ â”‚spec. â”‚ â”‚  state_  â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚  writer  â”‚ â”‚case_ â”‚ â”‚ updater  â”‚
                   â”‚                    â”‚          â”‚ â”‚handl.â”‚ â”‚          â”‚
                   â”‚                    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”¬â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
                   â”‚                         â”‚          â”‚          â”‚
                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                             â”‚
                                             â–¼
                                          [END]
```

---

## Detalle de los 3 Agentes

### ğŸ¤– AGENTE A: Context & Emotion Manager

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   CONTEXT & EMOTION MANAGER                   â”‚
â”‚                      (Agente Secundario)                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

INPUT:
  - last_user_message: "Â¡Ya llamÃ© 3 veces y nadie me soluciona!"
  - emotional_history: [turnos anteriores]
  - current_phase: "OUTBOUND_SERVICE_CONFIRMATION"

         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  LLM Analysis       â”‚
â”‚  (GPT-4o-mini)      â”‚
â”‚  Temp: 0.3          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ OUTPUT (JSON):                                      â”‚
â”‚ {                                                   â”‚
â”‚   "sentiment": "FrustraciÃ³n",                       â”‚
â”‚   "conflict_level": "Alto",                         â”‚
â”‚   "personality_adaptation": "Balanceado",           â”‚
â”‚   "sarcasm_detected": false,                        â”‚
â”‚   "ambiguity_detected": false,                      â”‚
â”‚   "emotional_validation_required": true,            â”‚
â”‚   "resolution_strategy": "ValidaciÃ³n Emocional"     â”‚
â”‚ }                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ UPDATE STATE:                                       â”‚
â”‚ - current_sentiment = "FrustraciÃ³n"                 â”‚
â”‚ - current_conflict_level = "Alto"                   â”‚
â”‚ - personality_mode = "Balanceado"                   â”‚
â”‚ - emotional_validation_required = True              â”‚
â”‚ - emotional_memory.append({                         â”‚
â”‚     "turn": 5,                                      â”‚
â”‚     "sentiment": "FrustraciÃ³n",                     â”‚
â”‚     "conflict_level": "Alto",                       â”‚
â”‚     "timestamp": "2024-01-20T10:05:00"              â”‚
â”‚   })                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### ğŸ­ AGENTE B: The Orchestrator

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      THE ORCHESTRATOR                         â”‚
â”‚                     (Agente Principal)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

INPUT:
  - llm_system_prompt: [Prompt base del context_builder]
  - current_sentiment: "FrustraciÃ³n"
  - conflict_level: "Alto"
  - personality_mode: "Balanceado"
  - emotional_validation_required: True
  - last_user_message: "Â¡Ya llamÃ© 3 veces y nadie me soluciona!"

         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ENRIQUECER PROMPT                              â”‚
â”‚                                                 â”‚
â”‚  Prompt base                                    â”‚
â”‚  +                                              â”‚
â”‚  AdaptaciÃ³n emocional:                          â”‚
â”‚  "âš ï¸ USUARIO FRUSTRADO/ENOJADO:                 â”‚
â”‚   - PRIORIDAD: ValidaciÃ³n emocional ANTES       â”‚
â”‚   - Usa: 'Entiendo su frustraciÃ³n...'           â”‚
â”‚   - NO des informaciÃ³n tÃ©cnica de inmediato"    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  LLM Response       â”‚
â”‚  (GPT-4-turbo)      â”‚
â”‚  Temp: 0.6          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ OUTPUT (JSON):                                      â”‚
â”‚ {                                                   â”‚
â”‚   "agent_response": "Entiendo su frustraciÃ³n,      â”‚
â”‚     Sr. PÃ©rez. PermÃ­tame ayudarle de inmediato.    â”‚
â”‚     He revisado su cita y confirmo que es el       â”‚
â”‚     20 de enero a las 10:00 AM. Â¿Podemos          â”‚
â”‚     confirmar que esta informaciÃ³n es correcta?",  â”‚
â”‚   "next_phase": "OUTBOUND_CLOSING",                â”‚
â”‚   "requires_escalation": false,                    â”‚
â”‚   "extracted": {}                                  â”‚
â”‚ }                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ UPDATE STATE:                                       â”‚
â”‚ - agent_response = "Entiendo su frustraciÃ³n..."    â”‚
â”‚ - next_phase = "OUTBOUND_CLOSING"                  â”‚
â”‚ - extracted_data = {}                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### ğŸ›¡ï¸ AGENTE C: The Guardrail

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       THE GUARDRAIL                           â”‚
â”‚                   (Agente de Seguridad)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

INPUT:
  - agent_response: [Respuesta del Orchestrator]
  - current_phase: "OUTBOUND_SERVICE_CONFIRMATION"
  - next_phase: "OUTBOUND_CLOSING"
  - known_data: {appointment_date: "2024-01-20", ...}
  - excel_data: {appointment_date: "2024-01-20", ...}

         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  VALIDACIONES CRÃTICAS:                         â”‚
â”‚                                                 â”‚
â”‚  1. Fallo LÃ³gico                                â”‚
â”‚     Â¿Cita fechas que NO estÃ¡n en Excel?        â”‚
â”‚     â†’ Comparar "20 de enero" con               â”‚
â”‚       excel_data.appointment_date              â”‚
â”‚     âœ… MATCH                                     â”‚
â”‚                                                 â”‚
â”‚  2. Seguridad                                   â”‚
â”‚     Â¿Revela datos a persona no autorizada?     â”‚
â”‚     â†’ Verificar contact_name vs patient_name   â”‚
â”‚     âœ… OK (es persona autorizada)                â”‚
â”‚                                                 â”‚
â”‚  3. Accesibilidad                               â”‚
â”‚     Â¿Lenguaje demasiado complejo?              â”‚
â”‚     â†’ Contar palabras por frase                â”‚
â”‚     âœ… OK (<30 palabras por frase)               â”‚
â”‚                                                 â”‚
â”‚  4. Consistencia                                â”‚
â”‚     Â¿Se despide sin confirmar datos?           â”‚
â”‚     â†’ next_phase="OUTBOUND_CLOSING"            â”‚
â”‚     â†’ Â¿Incluye fecha, hora, direcciÃ³n?         â”‚
â”‚     âœ… OK (incluye confirmaciÃ³n)                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  LLM Validation     â”‚
â”‚  (GPT-4o-mini)      â”‚
â”‚  Temp: 0.1          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ OUTPUT (JSON):                                      â”‚
â”‚ {                                                   â”‚
â”‚   "status": "APPROVED",                             â”‚
â”‚   "issues": [],                                     â”‚
â”‚   "correction_needed": null                         â”‚
â”‚ }                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ UPDATE STATE:                                       â”‚
â”‚ - safety_validation_status = "APPROVED"             â”‚
â”‚ - safety_issues_detected = []                       â”‚
â”‚ - validation_attempt_count++ (pero resetea luego)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Flujo de ValidaciÃ³n en Cascada (Con Rechazo)

### Escenario: Guardrail detecta error

```
TURNO 5:

Usuario: "Quiero confirmar mi cita"

         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Emotion Analyzer   â”‚ â†’ Neutro, Bajo conflicto
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Context Builder    â”‚ â†’ Prompt con datos de Excel
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   (appointment_date = "2024-01-20")
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Orchestrator (Intento #1)                      â”‚
â”‚                                                â”‚
â”‚ Genera: "Su cita es el 15 de enero a las      â”‚
â”‚          10:00 AM"  âŒ ERROR (deberÃ­a ser 20)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Safety Validator                               â”‚
â”‚                                                â”‚
â”‚ ValidaciÃ³n:                                    â”‚
â”‚ - Excel dice: 20 de enero                     â”‚
â”‚ - Respuesta dice: 15 de enero                 â”‚
â”‚ - MISMATCH â†’ REJECTED                          â”‚
â”‚                                                â”‚
â”‚ Output:                                        â”‚
â”‚ {                                              â”‚
â”‚   "status": "REJECTED",                        â”‚
â”‚   "issues": ["fallo_logico"],                  â”‚
â”‚   "correction_needed": "Fecha incorrecta.      â”‚
â”‚     Debe decir 20 de enero, no 15."            â”‚
â”‚ }                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”‚ validation_attempt_count = 1
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Route: REJECTED    â”‚ â†’ Volver a Orchestrator
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Orchestrator (Intento #2)                      â”‚
â”‚                                                â”‚
â”‚ Recibe en prompt:                              â”‚
â”‚ "ğŸ›¡ï¸ CORRECCIÃ“N DE SEGURIDAD:                   â”‚
â”‚  Tu respuesta anterior fue rechazada por:      â”‚
â”‚  'Fecha incorrecta. Debe decir 20 de enero'   â”‚
â”‚  Por favor, genera una nueva respuesta."       â”‚
â”‚                                                â”‚
â”‚ Genera: "Su cita es el 20 de enero a las      â”‚
â”‚          10:00 AM"  âœ… CORRECTO                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Safety Validator (Intento #2)                 â”‚
â”‚                                                â”‚
â”‚ ValidaciÃ³n:                                    â”‚
â”‚ - Excel dice: 20 de enero                     â”‚
â”‚ - Respuesta dice: 20 de enero                 â”‚
â”‚ - MATCH â†’ APPROVED âœ…                           â”‚
â”‚                                                â”‚
â”‚ Output:                                        â”‚
â”‚ {                                              â”‚
â”‚   "status": "APPROVED",                        â”‚
â”‚   "issues": []                                 â”‚
â”‚ }                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”‚ validation_attempt_count = 2
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Route: APPROVED    â”‚ â†’ Continuar a Response Processor
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”‚ (resetea validation_attempt_count = 0)
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Response Processor â”‚ â†’ Extrae datos, actualiza fase
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
        [END]

âœ… Respuesta final al usuario: "Su cita es el 20 de enero a las 10:00 AM"
```

---

## Memoria Emocional a lo largo de la ConversaciÃ³n

```
CONVERSACIÃ“N COMPLETA (5 turnos):

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TURNO 1: Saludo inicial                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Usuario: "Hola"                                            â”‚
â”‚ Emotion: Neutro, Bajo conflicto                            â”‚
â”‚ Respuesta: Saludo cordial                                  â”‚
â”‚                                                            â”‚
â”‚ emotional_memory = [                                       â”‚
â”‚   {turn: 1, sentiment: "Neutro", conflict: "Bajo"}        â”‚
â”‚ ]                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TURNO 2: IdentificaciÃ³n                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Usuario: "Soy Juan PÃ©rez"                                  â”‚
â”‚ Emotion: Neutro, Bajo conflicto                            â”‚
â”‚ Respuesta: ConfirmaciÃ³n y avance a siguiente fase          â”‚
â”‚                                                            â”‚
â”‚ emotional_memory = [                                       â”‚
â”‚   {turn: 1, sentiment: "Neutro", conflict: "Bajo"},       â”‚
â”‚   {turn: 2, sentiment: "Neutro", conflict: "Bajo"}        â”‚
â”‚ ]                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TURNO 3: Usuario se frustra                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Usuario: "Â¡Ya llamÃ© 3 veces y nadie me soluciona!"        â”‚
â”‚ Emotion: FrustraciÃ³n, Alto conflicto                       â”‚
â”‚ Respuesta: VALIDACIÃ“N EMOCIONAL activada                   â”‚
â”‚   "Entiendo su frustraciÃ³n, Sr. PÃ©rez..."                 â”‚
â”‚                                                            â”‚
â”‚ emotional_memory = [                                       â”‚
â”‚   {turn: 1, sentiment: "Neutro", conflict: "Bajo"},       â”‚
â”‚   {turn: 2, sentiment: "Neutro", conflict: "Bajo"},       â”‚
â”‚   {turn: 3, sentiment: "FrustraciÃ³n", conflict: "Alto"} â† â”‚
â”‚ ]                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TURNO 4: Usuario se calma                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Usuario: "Ok, gracias. Â¿CuÃ¡ndo es mi cita?"               â”‚
â”‚ Emotion: Incertidumbre, Medio conflicto                    â”‚
â”‚ Respuesta: Sigue siendo cordial (por la memoria)           â”‚
â”‚   "Con gusto le ayudo. Su cita es..."                     â”‚
â”‚                                                            â”‚
â”‚ emotional_memory = [                                       â”‚
â”‚   {turn: 1, sentiment: "Neutro", conflict: "Bajo"},       â”‚
â”‚   {turn: 2, sentiment: "Neutro", conflict: "Bajo"},       â”‚
â”‚   {turn: 3, sentiment: "FrustraciÃ³n", conflict: "Alto"},  â”‚
â”‚   {turn: 4, sentiment: "Incertidumbre", conflict: "Med."} â”‚
â”‚ ]                                                          â”‚
â”‚                                                            â”‚
â”‚ ğŸ’¡ Orchestrator ve que en turno 3 estaba frustrado        â”‚
â”‚    â†’ Mantiene tono extra-cordial aunque ya se calmÃ³       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TURNO 5: Cierre                                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Usuario: "Perfecto, gracias"                               â”‚
â”‚ Emotion: Euforia, Bajo conflicto                           â”‚
â”‚ Respuesta: Resumen final + Despedida cordial               â”‚
â”‚                                                            â”‚
â”‚ emotional_memory = [                                       â”‚
â”‚   {turn: 1, sentiment: "Neutro", conflict: "Bajo"},       â”‚
â”‚   {turn: 2, sentiment: "Neutro", conflict: "Bajo"},       â”‚
â”‚   {turn: 3, sentiment: "FrustraciÃ³n", conflict: "Alto"},  â”‚
â”‚   {turn: 4, sentiment: "Incertidumbre", conflict: "Med."},â”‚
â”‚   {turn: 5, sentiment: "Euforia", conflict: "Bajo"}       â”‚
â”‚ ]                                                          â”‚
â”‚                                                            â”‚
â”‚ âœ… Guardado en Redis para anÃ¡lisis y continuidad           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ComparaciÃ³n: Antes vs DespuÃ©s

### ANTES (Mono-Agente):

```
Usuario: "Â¡Ya llamÃ© 3 veces y nadie me soluciona!"

â†’ llm_responder genera:
  "Su cita es el 20 de enero a las 10:00 AM."

âŒ Problemas:
  - Sin empatÃ­a
  - Respuesta robÃ³tica
  - No valida emociÃ³n
  - No adapta tono
```

### DESPUÃ‰S (Multi-Agente):

```
Usuario: "Â¡Ya llamÃ© 3 veces y nadie me soluciona!"

â†’ Emotion Analyzer:
  sentiment: "FrustraciÃ³n"
  conflict: "Alto"
  emotional_validation_required: True

â†’ Orchestrator (con adaptaciÃ³n emocional):
  "Entiendo su frustraciÃ³n, Sr. PÃ©rez.
   PermÃ­tame ayudarle de inmediato.
   He revisado su cita y confirmo que es el
   20 de enero a las 10:00 AM en [direcciÃ³n].
   Â¿Podemos confirmar que esta informaciÃ³n es correcta?"

â†’ Safety Validator:
  âœ… Incluye validaciÃ³n emocional
  âœ… Datos correctos vs Excel
  âœ… Lenguaje accesible
  âœ… Pide confirmaciÃ³n
  â†’ APPROVED

âœ… Mejoras:
  - EmpÃ¡tico
  - Natural
  - Valida emociÃ³n
  - Tono adaptado
  - Seguro (validado)
```

---

## MÃ©tricas del Sistema

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   MÃ‰TRICAS POR TURNO                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                            â”‚
â”‚  Llamadas LLM:          3                                  â”‚
â”‚  â”œâ”€ Emotion Analyzer:   1 (temp 0.3, ~500 tokens)         â”‚
â”‚  â”œâ”€ Orchestrator:       1 (temp 0.6, ~1500 tokens)        â”‚
â”‚  â””â”€ Safety Validator:   1 (temp 0.1, ~800 tokens)         â”‚
â”‚                                                            â”‚
â”‚  Latencia total:        ~2-3 segundos                      â”‚
â”‚  â”œâ”€ Emotion Analyzer:   ~0.5s                             â”‚
â”‚  â”œâ”€ Orchestrator:       ~1.5s                             â”‚
â”‚  â””â”€ Safety Validator:   ~0.5s                             â”‚
â”‚                                                            â”‚
â”‚  Costo estimado:        2.5x vs mono-agente                â”‚
â”‚  (Mitigable con gpt-4o-mini en Analyzer/Validator)        â”‚
â”‚                                                            â”‚
â”‚  Tasa de rechazo:       ~5-10% (segÃºn calidad del prompt) â”‚
â”‚  Intentos promedio:     1.1 (mayorÃ­a aprobados 1er intento)â”‚
â”‚  Max intentos:          3 (luego auto-aprueba)            â”‚
â”‚                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Casos de Uso CrÃ­ticos

### Caso 1: Menor de Edad Contesta

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ OUTBOUND_GREETING                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Usuario: "Hola, soy Juanito" (15 aÃ±os)         â”‚
â”‚                                                â”‚
â”‚ â†’ Orchestrator extrae:                         â”‚
â”‚   contact_name: "Juanito"                      â”‚
â”‚   contact_age: 15  â† MENOR DE EDAD             â”‚
â”‚                                                â”‚
â”‚ â†’ Respuesta:                                   â”‚
â”‚   "Hola Juanito. Por favor, Â¿me puedes        â”‚
â”‚    comunicar con un adulto responsable?"       â”‚
â”‚                                                â”‚
â”‚ â†’ Safety Validator:                            â”‚
â”‚   âœ… Protocolo correcto aplicado                â”‚
â”‚   â†’ APPROVED                                   â”‚
â”‚                                                â”‚
â”‚ â†’ NO continÃºa hasta hablar con adulto          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Caso 2: Persona No Autorizada

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ OUTBOUND_GREETING                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Usuario: "Soy el vecino de Juan"               â”‚
â”‚                                                â”‚
â”‚ â†’ Orchestrator extrae:                         â”‚
â”‚   contact_name: "Vecino"                       â”‚
â”‚   contact_relationship: "Vecino"               â”‚
â”‚   â†’ NO es paciente NI persona autorizada       â”‚
â”‚                                                â”‚
â”‚ â†’ Respuesta:                                   â”‚
â”‚   "Por seguridad, debo hablar con Juan PÃ©rez. â”‚
â”‚    Â¿Se encuentra disponible?"                  â”‚
â”‚                                                â”‚
â”‚ â†’ Si NO estÃ¡:                                  â”‚
â”‚   "Entendido. Volveremos a llamar mÃ¡s tarde.  â”‚
â”‚    Buen dÃ­a."                                  â”‚
â”‚   next_phase: "OUTBOUND_CLOSING"               â”‚
â”‚                                                â”‚
â”‚ â†’ Safety Validator:                            â”‚
â”‚   âœ… NO revelÃ³ datos sensibles                  â”‚
â”‚   â†’ APPROVED                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Caso 3: Despedida sin Resumen

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ OUTBOUND_CLOSING (Intento incorrecto)          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Orchestrator genera:                           â”‚
â”‚   "Muchas gracias. Â¡Buen dÃ­a!"  âŒ              â”‚
â”‚                                                â”‚
â”‚ â†’ Safety Validator detecta:                    â”‚
â”‚   - next_phase = "END"                         â”‚
â”‚   - Pero NO hay resumen de:                    â”‚
â”‚     â€¢ Tipo de servicio                         â”‚
â”‚     â€¢ Fecha                                    â”‚
â”‚     â€¢ Hora                                     â”‚
â”‚     â€¢ DirecciÃ³n                                â”‚
â”‚     â€¢ ConfirmaciÃ³n del usuario                 â”‚
â”‚     â€¢ IdentificaciÃ³n del agente                â”‚
â”‚                                                â”‚
â”‚ â†’ Output:                                      â”‚
â”‚   {                                            â”‚
â”‚     "status": "REJECTED",                      â”‚
â”‚     "issues": ["consistencia"],                â”‚
â”‚     "correction_needed": "Falta resumen final. â”‚
â”‚       Debe incluir servicio, fecha, hora,      â”‚
â”‚       direcciÃ³n y confirmaciÃ³n del usuario."   â”‚
â”‚   }                                            â”‚
â”‚                                                â”‚
â”‚ â†’ Orchestrator regenera con correcciÃ³n:        â”‚
â”‚   "Para confirmar: su cita de DiÃ¡lisis es el  â”‚
â”‚    20 de enero a las 10:00 AM. Pasaremos a    â”‚
â”‚    recogerle en Calle 123. Â¿La informaciÃ³n    â”‚
â”‚    es clara? HablÃ³ con MarÃ­a de Transpormax.  â”‚
â”‚    Â¡Buen dÃ­a!"                                 â”‚
â”‚                                                â”‚
â”‚ â†’ Safety Validator:                            â”‚
â”‚   âœ… Incluye todos los elementos                â”‚
â”‚   â†’ APPROVED                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Persistencia y Continuidad

### Thread_id para Sesiones Interrumpidas

```
LLAMADA 1 (Se corta en turno 3):

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ session_id: abc-123              â”‚
â”‚ thread_id: abc-123 (mismo)       â”‚
â”‚ current_phase: SERVICE_CONFIRM   â”‚
â”‚ emotional_memory: [...]          â”‚
â”‚ turn_count: 3                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ LLAMADA SE CORTA âŒ
         â”‚
         â–¼
    [Guardado en Redis]

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

LLAMADA 2 (Usuario vuelve a llamar):

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ session_id: abc-123 (MISMO)      â”‚
â”‚ thread_id: abc-123               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
    [Carga desde Redis]
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âœ… Estado completo restaurado:    â”‚
â”‚ - current_phase: SERVICE_CONFIRM â”‚
â”‚ - emotional_memory: [...]        â”‚
â”‚ - turn_count: 3                  â”‚
â”‚ - known_data: {...}              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Agente continÃºa desde donde      â”‚
â”‚ se quedÃ³, con memoria emocional  â”‚
â”‚ intacta                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```
